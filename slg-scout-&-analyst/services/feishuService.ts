import { ReportData } from "../types";

const APP_ID = "cli_a9a2a01b94781cd4";
const APP_SECRET = "OT3MM3QOdaArCpfmP5wvlbgQSGd5nmbP";

// ä½¿ç”¨ CORS ä»£ç† (ä»…ç”¨äºæ¼”ç¤º/å¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨åç«¯è½¬å‘)
// è¿™æ˜¯ä¸€ä¸ªå…¬å…±æ¼”ç¤ºä»£ç†ï¼Œå¹¶ä¸ä¿è¯ 100% ç¨³å®šã€‚å¦‚æœå¤±è´¥ï¼Œè¯´æ˜éœ€è¦éƒ¨ç½²çœŸæ­£çš„åç«¯ã€‚
export const CORS_PROXY = "https://cors-anywhere.herokuapp.com/"; 

export const getTenantAccessToken = async (): Promise<string> => {
  try {
    const url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal";
    
    // å°è¯•ç›´æ¥è¯·æ±‚ (å¦‚æœæµè§ˆå™¨ç¦ç”¨äº†å®‰å…¨ç­–ç•¥)
    try {
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json; charset=utf-8" },
            body: JSON.stringify({ app_id: APP_ID, app_secret: APP_SECRET }),
        });
        if (response.ok) {
            const data = await response.json();
            return data.tenant_access_token;
        }
    } catch (e) {
        console.warn("Direct fetch failed (expected CORS), trying proxy...");
    }

    // å°è¯•ä½¿ç”¨ Proxy
    // æ³¨æ„ï¼šç”¨æˆ·éœ€è¦å…ˆè®¿é—® https://cors-anywhere.herokuapp.com/demo ç”³è¯·ä¸´æ—¶æƒé™æ‰èƒ½ä½¿ç”¨æ­¤å…¬å…±ä»£ç†
    const proxyResponse = await fetch(`${CORS_PROXY}${url}`, {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify({ app_id: APP_ID, app_secret: APP_SECRET }),
    });

    if (!proxyResponse.ok) {
        const errText = await proxyResponse.text();
        throw new Error(`Auth Failed: ${proxyResponse.status} ${proxyResponse.statusText} - ${errText}`);
    }

    const data = await proxyResponse.json();
    return data.tenant_access_token;

  } catch (error: any) {
    console.error("Error getting Feishu token:", error);
    throw new Error(`é£ä¹¦é‰´æƒå¤±è´¥ (CORS é™åˆ¶)ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ã€‚é”™è¯¯: ${error.message}`);
  }
};

interface ChatItem {
    chat_id: string;
    name: string;
}

export const getBotGroups = async (token: string): Promise<ChatItem[]> => {
    try {
        const url = `https://open.feishu.cn/open-apis/im/v1/chats?page_size=100`;
        
        // åŒæ ·å°è¯• Proxy
        const response = await fetch(`${CORS_PROXY}${url}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
            }
        });

        if (!response.ok) {
            console.warn("Failed to fetch chat list via proxy.");
            return []; 
        }

        const data = await response.json();
        if (data.code !== 0) {
             console.error("Feishu API Error:", data);
             return [];
        }
        return data.data?.items || [];
    } catch (e) {
        console.error("Error fetching groups:", e);
        return [];
    }
}

const createFeishuCard = (data: ReportData) => {
  const elements = data.games.flatMap((game) => [
    {
      tag: "div",
      text: {
        tag: "lark_md",
        content: `**ğŸ® ${game.name}**\n${game.description}\n\n**ğŸ§© æ ¸å¿ƒç©æ³•:** ${game.gameplayMechanics}\n**ğŸ“Š é€‚é…è¯„åˆ†:** ${game.rokCodFeasibilityScore}/10\n*ğŸ’¡ ç»“åˆå»ºè®®: ${game.rokCodAnalysis}*`
      }
    },
    {
      tag: "action",
      actions: [
        {
          tag: "button",
          text: { tag: "plain_text", content: "ğŸ“º è§‚çœ‹ Gameplay" },
          url: game.youtubeQuery,
          type: "danger"
        },
        {
          tag: "button",
          text: { tag: "plain_text", content: "â–¶ï¸ Google Play" },
          url: game.googlePlayLink,
          type: "primary"
        }
      ]
    },
    {
      tag: "hr"
    }
  ]);

  if (elements.length > 0) elements.pop();

  return {
    config: { wide_screen_mode: true },
    header: {
      template: "blue",
      title: { tag: "plain_text", content: `ğŸ“… æ¯æ—¥æ–°æ¸¸ç›‘æµ‹æŠ¥å‘Š: ${data.date}` }
    },
    elements: [
      {
        tag: "div",
        text: { tag: "lark_md", content: `**ğŸ“ å¸‚åœºæ€»ç»“:** ${data.summary}` }
      },
      { tag: "hr" },
      ...elements,
      {
        tag: "note",
        elements: [{ tag: "plain_text", content: "Generated by SLG Scout AI" }]
      }
    ]
  };
};

export const broadcastToFeishu = async (data: ReportData) => {
  try {
    const token = await getTenantAccessToken();
    const groups = await getBotGroups(token);

    if (groups.length === 0) {
        throw new Error("æœªæ‰¾åˆ°æœºå™¨äººæ‰€åœ¨çš„ç¾¤ç»„ã€‚å¯èƒ½åŸå› ï¼š1. æœºå™¨äººæœªè¢«æ‹‰å…¥ç¾¤ç»„ 2. CORS é˜»æ­¢äº†åˆ—è¡¨è·å–ã€‚");
    }

    const cardContent = createFeishuCard(data);
    const results = [];

    for (const group of groups) {
        const url = `https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=chat_id`;
        const response = await fetch(`${CORS_PROXY}${url}`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json; charset=utf-8",
            },
            body: JSON.stringify({
                receive_id: group.chat_id,
                msg_type: "interactive",
                content: JSON.stringify(cardContent),
            }),
        });
        
        results.push({
            id: group.chat_id,
            name: group.name,
            status: response.ok ? 'success' : 'failed'
        });
    }

    return results;
  } catch (error) {
    console.error("Feishu Broadcast Error:", error);
    throw error;
  }
};